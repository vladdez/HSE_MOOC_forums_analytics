---
title: "Длительность прохождения и посещение форума"
output:
  html_document:
    code_download: yes
    fontsize: 8pt
    highlight: textmate
    number_sections: no
    theme: flatly
    toc: yes
    toc_float:
      collapsed: no
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(dplyr)
library(data.table)
library(lme4)
library(ggplot2)
library(pscl)
library(arm)
library(sjPlot)

remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  y
}

```

```{r, include=FALSE}
wd <- getwd()
students <- fread("../data/students.csv") %>% filter(duration < 400) %>% 
  group_by(course_id) %>%
  mutate(vis_p_n = vis_p / mean(vis_p, na.rm = TRUE),
    duration_n = duration / mean(duration, na.rm = TRUE) 
) %>% ungroup()

students$vis_b <-factor(students$vis_b)
students$spec_b <-factor(students$spec_b)

```


## 1. Об отчете

### Исследовательские вопросы

  1. Как длительность прохождения курса влияет на число посещенных страниц форума?
  2. Как число посещенных страниц форума варьируется в зависимости от курса?
  3. Как нормализованная длительность прохождения курса влияет на нормализованное посещение форума?

### Содержание отчета
 
  1. Влияние количества посещенных страниц на длительность прохождения курса.
  2. Дисперсия посещения среди разных курсов.
  3. Влияние нормализованного количества посещенных страниц на нормализованную длительность прохождения курса.

## Описание переменных

  - ***vis_p*** - индивидуальное посещение форума;
  - ***duration*** - индивидуальная длительность прохождения курса в днях;
  - ***vis_p_n*** - нормализованное посещение = индивидуальное посещение форума / среднее посещение форума на курсе;
  - ***duration_n*** - нормализованное прохождение = индивидуальная длительность прохождения курса / среднее посещение форума на курсе;

## 1. Влияние количества посещенных страниц на длительность прохождения курса

Выбор статистических инструментов:

  1. Переменная vis_p счетная, для таких переменных используется пуассоновское или отрицательно-биномиальное распределение.
  2. how extra-Poisson variation (i.e., overdispersion), odTest(), поможет нам выбрать необходимое распределение. Оно проверяет верно ли необходимое условие для использование Пуассоновской регрессии - равенство условного среднего и условного распределения. Если значение p-value меньше 0.05, то гипотеза о чрезмерной дисперсии не может быть отброшена. В таком случае следует применять отрицательно-биномиальное распределение.


```{r}
m1 <-  glm.nb(duration ~ vis_p_n, students)
od <- odTest(m1)

```

```{r}
m1 <- glm.nb(duration ~ vis_p, students)
summary(m1)
```

```{r}
tab_model(m1)
```


```{r , echo=FALSE}
cat(sprintf("Увеличение количества посещенных страниц форума на 1 страницу удлиняет ожидаемое прохождение курса на %.3f дней.\n", exp(m1$coefficients[2])))
cat(sprintf("Человек, который совершил 1 посещение форума закончил курс за %.2f дней.\n", (exp(m1$coefficients[1] + m1$coefficients[2]* 1))))
cat(sprintf("Человек, который совершил 16 посещений форума закончил курс за %.2f дней.\n", (exp(m1$coefficients[1] + m1$coefficients[2]* 16))))
cat(sprintf("Человек, который совершил 500 посещений форума закончил курс за %.2f дней.\n ", (exp(m1$coefficients[1] + m1$coefficients[2]* 500))))

```


```{r}
students %>% 
  ggplot(aes(y = duration, x = vis_p)) + geom_point() +  geom_smooth(method="glm.nb", color = "red") + ggtitle("Влияние посещения форума на длительность прохождения курса") + labs(x="Посещенные страницы", y = "Дни") +  theme(plot.title = element_text(hjust = 0.5))
```


## 2. Дисперсия посещения среди разных курсов

Почему используем НБ регрессию: потому что среднее меньше отклоенения

### Дисперсия длительности

```{r}
students %>% summarise(mean = mean(duration), variance = var(duration))
```

```{r}
m0 <- glmer.nb(duration ~ 1 + (1|course_id), students)
summary(m0)

```

```{r, include=FALSE}
sd <- as.numeric(data.frame(VarCorr(m0))[5])
coef <- display(m0)$coef
c <- c(round(exp(coef - sd), digits = 2), round(exp(coef + sd), digits = 2))

```

```{r, echo=FALSE}

cat(sprintf("Средняя длительность прохождения курса - %.2f (доверительный интервал %.2f-%.2f, SD = %.2f) дней.", exp(coef), c[1] , c[2],  exp(sd)))
```

### Дисперсия посещений

```{r, echo=FALSE}
m0 <- glmer.nb(vis_p ~ 1 + (1|course_id),
            students)
summary(m0)


```

```{r, include=FALSE}
sd <- as.numeric(data.frame(VarCorr(m0))[5])
m0d <- display(m0)
coef = m0d$coef
c <- c(round(exp(coef - sd), digits = 0), round(exp(coef + sd), digits = 0))
```

```{r , echo=FALSE}
cat(sprintf("Среднее количество просмотренных страниц - %.2f (доверительный интервал %.2f-%.2f, SD = %.2f) дней.\nЧтобы этот разброс не влиял на наши расчеты мы будем использовать нормализованные дни.", exp(coef), c[1] , c[2],  exp(sd)))

```

```{r}
students %>% group_by(course_id) %>% summarize(mean_vis = mean(vis_p, na.rm = TRUE), mean_dur = mean(duration, na.rm = TRUE)) %>% summarise(sd_vis = sd(mean_vis), sd_dur = sd(mean_dur))
```


## 3. Влияние  количества посещенных страниц на длительность прохождения курса  со случайным свободным членом

```{r}
m1 <- glmer.nb(duration ~ vis_p_n + (1|course_id), students)
summary(m1)
```
```{r}
tab_model(m1)
```


```{r , echo=FALSE}
cat(sprintf("Увеличение нормализованного количества посещенных страниц форума на 1 страницу удлиняет ожидаемое прохождение курса на %.2f дней.\n", exp(summary(m1)$coefficients[2])))
cat(sprintf("Человек, который совершил 1 нормализованное посещение форума закончил курс за %.2f дней.\n", (exp(summary(m1)$coefficients[1] + summary(m1)$coefficients[2]* 1))))
cat(sprintf("Человек, который совершил 10 нормализованных посещений форума закончил курс за %.2f дней.\n", (exp(summary(m1)$coefficients[1] + summary(m1)$coefficients[2]* 10))))
cat(sprintf("Человек, который совершил 20 нормализованных посещений форума закончил курс за %.2f дней.\n ", (exp(summary(m1)$coefficients[1] + summary(m1)$coefficients[2]* 20))))

```

```{r}
students %>% filter(vis_p_n <20 ) %>%
  ggplot(aes(y = duration, x = vis_p_n)) + geom_point() +  geom_smooth(method="glm.nb", color = "red") + ggtitle("Влияние посещения форума на длительность прохождения курса") + labs(x="Нормализованные посещения", y = "Дни") +  theme(plot.title = element_text(hjust = 0.5))
```

```{r}
students %>% filter(vis_p_n <20 ) %>%
  ggplot(aes(y = duration, x = vis_p_n)) + geom_point() +  geom_smooth(method="glm.nb", color = "red") + ggtitle("Влияние посещения форума на длительность прохождения курса") + labs(x="Нормализованные посещения", y = "Дни") +  theme(plot.title = element_text(hjust = 0.5)) + facet_wrap(~course_id)
```


## Means

```{r}
students_short <- students %>% group_by(course_slug) %>% summarise(vis_mean = round(mean(vis_p, na.rm =TRUE)), duration_mean = round(mean(duration, na.rm =TRUE), digits = 2))
```

```{r}
m2 <- lm(duration_mean ~ vis_mean, students_short)
summary(m2)
```

```{r}
students_short  %>%
  ggplot(aes(y = duration_mean, x = vis_mean)) + geom_point() +  geom_smooth(method="lm",color = "red") + ggtitle("Влияние посещения форума на длительность прохождения курса") + labs(x="Среднее посещения", y = "Средняя длительность") +  theme(plot.title = element_text(hjust = 0.5)) 
```
```{r}
res <- resid(m2)
plot(fitted(m2), res)
abline(0,0)
qqnorm(res)
qqline(res)
```
```{r}
m2 <- lm(duration_mean ~ remove_outliers(vis_mean), students_short)
summary(m2)
```
```{r}
res <- resid(m2)
plot(fitted(m2), res)
abline(0,0)
qqnorm(res)
qqline(res)
```
## Выводы

    1. Чем дольше люди выполняют задания, тем чаще они обращаются к форуму.
    2. Увеличение нормализованного количества посещений форума на 1 пункт удлиняет ожидаемое прохождение курса на 5% нормализованных дней.
 




