---
title: "Модель Раша"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(dplyr)
library(data.table)
library(lme4)
library(ggplot2)
library(tidyr)
library(pscl)
library(arm)
library(broom)

remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  y
}

```

```{r}
wd <- getwd()
assignments <- fread("unzip -cq ../data/assignments.zip")  %>% group_by(course_name) %>%
  filter(course_item_type_desc != "lecture") %>% mutate(course_item_type_desc = factor(course_item_type_desc))

```


## 1. Об отчете

### Исследовательские вопросы

  1. Как связаны вероятность выполнения задания и посещение форума во время выполнения задания?
  2. Как связаны число попыток и посещение форума во время выполнения задания?

### Содержание отчета
 
  1. Дисперсия переменной assessment_status;
  2. Связь вероятности выполнения задания с посещением форума во время выполнения задания;
  3. Связь числа попыток с посещением форума во время выполнения задания.

## Описание переменных
 
  - **attempts** - Попытки за задание. Сколько попыток этот студент сделал при решении этого задания;
  - **vis_tw** - Посещения форума. Сколько раз этот студент посещал форум во время прохождения этого задания. Важно: считается посещение форума за все время пока студент взаимодействует с задачей;
  - **assessment_status** - Статус выполнения задания: 1 - удалось решить, 0 - не удалось решить.
  - **first_attempt** - Статус выполнения задания с первой попытки: 1 - удалось решить с первой попытки, 0 - не удалось решить с первой попытки.
  - **assignments** - база данных, с данными на уровне студентов
  - **assessment_id** - токен задания;
  - **hse_user_id** - токен студента;
  - **course_item_type_desc** - тип задания;
    - ***lecture*** - тест в видео (исключаю из анализа);
    - ***test*** - тест;
    - ***programming*** - задание по программированию;

#### О модели Раша

Модель Раша - популярная психометрическая модель, предполагающая нелинейную связь между оценками студента за задание и его знаниями.
Мы будем знания определять с помощью попыток за задания и посещений форума.

#### Распределение переменной assessment_status

```{r}
table(assignments$assessment_status)
table(assignments$first_attempt)
```
#### Распределение переменной attempts

```{r}
summary(assignments$attempts)
summary(assignments$vis_before_attempt_tw)
hist(assignments$attempts)
hist(assignments$vis_before_attempt_tw)
```

## 2. Вероятность выполнить задание с первой попытки

#### Дисперсия статуса выполнения задания по студентам и заданиям

```{r}
mr0 <- glmer(data = assignments, factor(first_attempt) ~ 1 + (1|hse_user_id) + (1|course_item_name), family = "binomial")
summary(mr0)
```


```{r}
mr1 <- glmer(data = assignments, factor(first_attempt) ~ 1 + vis_before_attempt_tw + (1|hse_user_id) + (1|course_item_name), family = "binomial")
summary(mr1)
mrr1 <- summary(mr1)
```

```{r, echo=FALSE}
cat(sprintf("Вероятность, что студент выполнит задание с первой попытки, если до первой попытки он не посещал форум, равна %.2f.\n", invlogit(mrr1$coefficients[1])))
cat(sprintf("С увеличением на 1 пункт посещения форума вероятность выполнить задание с первой попытки изменится в %.2f раз.\n\n", invlogit(mrr1$coefficients[1] + mrr1$coefficients[2]*6) - invlogit(mrr1$coefficients[1] + mrr1$coefficients[2]*5)))
cat(sprintf("Например, если студент посетил форум 1 раз до совершения попытки,\nто вероятность, что студент выполнит задание будет равна %.2f\n\n", invlogit(mrr1$coefficients[1] + mrr1$coefficients[2])))
cat(sprintf("А если студент посетил форум 25 раз,\nто вероятность, что студент выполнит задание будет равна %.2f\n\n", invlogit(mrr1$coefficients[1] + mrr1$coefficients[2]* 25)))
```

```{r, warning=FALSE}
assignments  %>%   ggplot(aes(x = vis_before_attempt_tw, y = first_attempt)) +
  geom_point(aes(color = as.factor(first_attempt)), shape = 1)   +  
# построит регрессионную линию, сигмоиду
  geom_smooth(method = "glm", color = "red", method.args=list(family="binomial")) +   
# напечатает легенду, название графика и осей  
  ggtitle("Вероятность сдать тест с первой попытки и\nпосещение форума до первой попытки") +
  scale_color_discrete(labels=c("Не сдал", "Сдал")) +
  labs(x = "Количество посещенных страниц до первой попытки", y = "Вероятность сдать тест с первой попытки", color = "Первая попытка") +
# задает цветовую тему графика
  theme_bw() +  
# выравнивает название по центру
  theme(plot.title = element_text(hjust = 0.5))

```

```{r}
anova(mr0, mr1)
```

## 3. Число попыток и посещение форума

Считаем только по выполненным заданиям.

```{r}
visits_attempts <- assignments %>% filter(assessment_status == 1)

```

```{r}
mr3 <- glmer(data = visits_attempts, attempts ~ 1 + vis_tw + (1|hse_user_id) + (1|course_item_name), family = "poisson")
summary(mr3)
mrr3 <- summary(mr3)
```

```{r, echo=FALSE}
cat(sprintf("Ожидаемое число попыток, чтобы выполнить задание, без посещения форума равно %.2f.\n", exp(mrr3$coefficients[1])))
cat(sprintf("С увеличением числа посещенных страниц на 1 пункт ожидаемое число попыток увеличиться в %.2f раз, т.е. на %d %%.\n", exp(mrr3$coefficients[2]), round( exp(mrr3$coefficients[2] - 1))*100, digits = 0))
cat(sprintf("Например, если студент посетил форум 25 раз, то ожидаемое число попыток, которое он сделает равно %.5f.\n\n", exp(mrr3$coefficients[1] + mrr3$coefficients[2]* 25) ))
```


## Выводы

  1. По модифицированной модели Раша существует значимая отрицательная связь между количеством посещенных страниц форума до выполнения задания и вероятностью выполнить задание c первой попытки с учетом индивидуальных различий студентов и заданий.
  2.  С увеличением на 1 пункт посещения форума отношение вероятность сдать тест на отлично увеличивается в 0.01 раз. То есть посещение форума, позволяет с большей вероятностью сдать тест.
  3. Число посещений форума во время выполнения задания коррелирует с количеством попыток положительно. С увеличением числа посещенных страниц на 1 пункт ожидаемое число попыток увеличиться в 1.01 раз. Возможно чем больше попыток человек совершает, тем чаще он будет заходить на форум.




