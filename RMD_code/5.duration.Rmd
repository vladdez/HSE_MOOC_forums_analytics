---
title: "Длительность прохождения и посещение форума"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(dplyr)
library(data.table)
library(lme4)
library(ggplot2)
library(pscl)
library(arm)

remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  y
}

```

```{r, include=FALSE}
wd <- getwd()
students <- fread("../data/students.csv")  %>% group_by(course_id) %>%
  mutate(vis_p_n = vis_p / mean(vis_p, na.rm = TRUE),
    duration_n = duration / mean(duration, na.rm = TRUE)
)

students$vis_b <-factor(students$vis_b)
students$spec_b <-factor(students$spec_b)

```


## 1. Об отчете

### Исследовательские вопросы

  1. Как длительность прохождения курса влияет на число посещенных страниц форума?
  2. Как число посещенных страниц форума варьируется в зависимости от курса?
  3. Как нормализованная длительность прохождения курса влияет на нормализованное посещение форума?

### Содержание отчета
 
  1. Влияние количества посещенных страниц на длительность прохождения курса.
  2. Дисперсия посещения среди разных курсов.
  3. Влияние нормализованного количества посещенных страниц на нормализованную длительность прохождения курса.

## Описание переменных

  - ***vis_p*** - индивидуальное посещение форума;
  - ***duration*** - индивидуальная длительность прохождения курса;
  - ***vis_p_n*** - нормализованное посещение = индивидуальное посещение форума / среднее посещение форума;
  - ***duration_n*** - нормализованное прохождение = индивидуальная длительность прохождения курса / среднее посещение форума;

## 1. Влияние количества посещенных страниц на длительность прохождения курса

Выбор статистических инструментов:

  1. Переменная vis_p счетная, для таких переменных используется пуассоновское или отрицательно-биномиальное распределение.
  2. Overdispersion test, odTest(), поможет нам выбрать необходимое распределение. Оно проверяет верно ли необходимое условие для использование Пуассоновской регрессии - равенство условного среднего и условного распределения. Если значение p-value меньше 0.05, то гипотеза о чрезмерной дисперсии не может быть отброшена. В таком случае следует применять отрицательно-биномиальное распределение.


```{r}
m1 <-  glm.nb(vis_p  ~ duration, students)
od <- odTest(m1)

```

```{r}
m1 <-  glm.nb(vis_p  ~ duration, students)
summary(m1)
```

```{r, include=FALSE}
m <- summary(m1)
```

```{r , echo=FALSE}
cat(sprintf("С каждым днем выполнения курса ожидаемое количество просмотренных страниц форума  увеличивается в %.4f раз.\n", exp(m1$coefficients[2])))
cat(sprintf("Этот эффект статистически значим: x_squared = %.3f, p = %.6f.\n", m[12]$coefficients[2], m[12]$coefficients[8]))
```

```{r, echo =FALSE, warning=FALSE}
students %>% filter(vis_p < 1000, duration  < 400) %>% ggplot(aes(y = vis_p , x = duration)) + geom_point() + geom_smooth(method = "glm.nb") + ggtitle("Длительность прохождения и посещение форума") + labs(y="Количество посещенных страниц", x = "Длительность прохождения курса в днях") +  theme(plot.title = element_text(hjust = 0.5))
```

## 2. Дисперсия посещения среди разных курсов
### Дисперсия длительности

```{r}
m0 <- glmer.nb(duration ~ 1 + (1|course_id), students)
summary(m0)
```

```{r, include=FALSE}
sd <- as.numeric(data.frame(VarCorr(m0))[5])
m0d <- display(m0)
coef = m0d$coef
c <- c(round(invlogit(coef - sd), digits = 2), round(invlogit(coef + sd), digits = 2))

```

```{r, echo=FALSE}

cat(sprintf("Средняя длительность прохождения курса различается на разных курсах: от %.2f до %.2f дней.\nЧтобы этот разброс не влиял на наши расчеты мы будем использовать нормализованные дни.", c[1] , c[2]))
```

### Дисперсия посещений

```{r, echo=FALSE}
m0 <- glmer.nb(vis_p ~ 1 + (1|course_id),
            students)
summary(m0)


```

```{r, include=FALSE}
sd <- as.numeric(data.frame(VarCorr(m0))[5])
m0d <- display(m0)
coef = m0d$coef
c <- c(round(invlogit(coef - sd), digits = 0), round(invlogit(coef + sd), digits = 0))
```

```{r , echo=FALSE}
cat(sprintf("Среднее количество посещений форума колеблется от курса к курсу: от %.f до %.f.\nЧтобы этот разброс не влиял на наши расчеты мы будем использовать нормализованное посещение.", c[1], c[2]))

```

```{r}
students %>% filter(vis_p_n <20 ) %>%
  ggplot(aes(y = duration_n, x = vis_p_n)) + geom_point() +  geom_smooth(method="glm.nb", color = "red") + ggtitle("Влияние посещения форума на длительность прохождения курса") + labs(x="Нормализованные посещения", y = "Нормализованные дни") +  theme(plot.title = element_text(hjust = 0.5))
```


## 3. Влияние нормализованного количества посещенных страниц на нормализованную длительность прохождения курса

```{r}
m1 <- glm.nb(duration_n ~ vis_p_n, students)
summary(m1)
```

```{r , echo=FALSE}
cat(sprintf("Увеличение нормализованного количества посещенных страниц форума на 1 страницу удлиняет ожидаемое прохождение курса на %.2f нормализованных дней, т.е. на 5%%.\n", exp(m1$coefficients[2])))
cat(sprintf("Человек, который совершил 16 нормализованных посещений форума на %.2f нормализованных дней позже закончил курс.\n ", (exp(m1$coefficients[1] + m1$coefficients[2]* 16))))

```


## Выводы

    1. Чем дольше люди выполняют задания, тем чаще они обращаются к форуму.
    2. Увеличение нормализованного количества посещений форума на 1 пункт удлиняет ожидаемое прохождение курса на 5% нормализованных дней.
 



