---
title: "Влияние модераторов на посещение форума. Выживаемость"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(dplyr)
library(data.table)
library(lme4)
library(broom)
library(ggplot2)
library(tidyr)
library(arm)
library(rstatix)
library(ggpubr)

remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  y
}

```



```{r, include=FALSE}
wd <- getwd()
students <- fread("../data/students.csv") %>% group_by(course_id) %>%
  mutate(vis_p = remove_outliers(vis_p), duration = remove_outliers(duration)) %>%  mutate(grade_norm = remove_outliers(grade_norm)) %>% filter(duration < 750)
students$vis_b <-factor(students$vis_b)
students$spec_b <-factor(students$spec_b)


courses <- fread("../data/courses.csv")%>%
  mutate(vis_learner_p_norm = round(student_n / vis_learner_p, digits = 2), student_vis_mean = remove_outliers(student_vis_mean), passing_rate = passing_rate * 100,
         q_staff_n = round(q_staff / student_n, digits = 2) *100, ans_staff_n = round(ans_staff / student_n, digits = 2)*100, q_learner_n = round(q_learner / student_n, digits = 2) *100,
         ans_learner_n = round(ans_learner / student_n, digits = 2) *100,
         q_staff_b = case_when(
    q_staff_n >= 1 ~ 1,
    q_staff_n < 1  ~ 0
), ans_staff_b = case_when(
    ans_staff_n >= 1 ~ 1,
    ans_staff_n < 1  ~ 0
))


```

## 1. Об отчете

### Исследовательские вопросы

  1. Как длительность прохождения курса влияет на количество посещений форума?
  2. Как посещение форума варьируется в зависимости от курса?
  3. Как нормализованная длительность прохождения курса влияет на нормализованное посещение форума?

## Содержание отчета

  1. Связь между типом курса и средним посещением форума на курсе
  2. Связь между выживаемостью на курсе и средним посещением форума на курсе
  3. Связь между нормализованной активностью студентов и нормализованной активностью модераторов на форуме;
  4. Связь между выживаемостью на курсе и нормализованной активностью студентов и модераторов;

### Описание баз данных

- **students** - длинная база данных, с данными на уровне студентов
- **courses** - короткая база данных, с данными на уровне курсов

### Описание переменных
 
- **Метрики форума**
  - ***student_vis_mean*** - среднее посещение форума студентами на курсе;
  - ***ans_learner*** - абсолютное количество ответов студентов на курсе;
  - ***q_learner*** - абсолютное количество вопросов студентов на курсе;
  - ***ans_learner_n*** - количество ответов студентов на курсе / количество студентов на курсе;
  - ***q_learner_n*** - количество вопросов студентов на курсе / количество студентов на курсе;

- **Метрики активности модераторов**
  - ***ans_staff*** - абсолютное количество ответов модераторов на курсе;
  - ***q_staff*** - абсолютное количество вопросов модераторов на курсе;
  - ***ans_staff_b*** - отвечали ли модераторы на вопросы на курсе (1 от 10 ответов);
  - ***q_staff_b*** - задавали ли модераторы вопросы на курсе (1 от 10 вопросов);
  - ***ans_staff_n*** - (количество ответов модераторов / количество студентов) *100;
  - ***q_staff_n*** - (количество вопросов модераторов / количество студентов) * 100;
 
 
- **Метрика выживаемости**
  - ***passing_rate*** - прошедшие курс / записавшиеся на курс


```{r , echo=FALSE}

cat(sprintf("Распределение курсов по типу заданий:\n"))
a <- courses %>% summarise(yes = sum(is_prog_b), no = n() - yes)
b <- courses %>% summarise(yes = sum(is_math_b), no = n() - yes)
c <- courses %>% summarise(yes = sum(is_peer_b), no = n() - yes)
d <- rbind(a, b, c)
d$course_with <- c("prog", "math", "peer")
d %>% dplyr::select(course_with, yes, no)
courses <-  courses %>% mutate(is_prog_b = factor(is_prog_b),
  is_math_b = factor(is_math_b),is_peer_b = factor(is_peer_b), ans_staff_b = factor(ans_staff_b), q_staff_b = factor(q_staff_b))
```


## 3. Модераторы и их влияние
### 3.1 Описание переменных и обоснование их выбора



```{r, echo=FALSE}
cat(sprintf("Распределение переменной q_staff_n:\n"))
table(courses$q_staff_n)
cat(sprintf("\nРаспределение переменной ans_staff_n:\n"))
table(courses$ans_staff_n)
```

```{r, echo=FALSE}
stat.test <- courses %>%
  wilcox_test(student_n ~ q_staff_b) %>%
  add_significance()
bxp <- ggboxplot(
  courses, x = "q_staff_b", y = "student_n",
  ylab = "Количество студентов на курсе", xlab = "Спрашивают ли модераторы?", add = "jitter") +
scale_x_discrete(labels=c("Нет","Да"))
stat.test <- stat.test %>% add_xy_position(x = "group")
bxp +
  stat_pvalue_manual(stat.test, tip.length = 0) +
  labs(subtitle = get_test_label(stat.test, detailed = TRUE))

stat.test <- courses %>%
  wilcox_test(student_n ~ ans_staff_b) %>%
  add_significance()
bxp <- ggboxplot(
  courses, x = "ans_staff_b", y = "student_n",
  ylab = "Количество студентов на курсе", xlab = "Отвечают ли модераторы?", add = "jitter") +
scale_x_discrete(labels=c("Нет","Да"))
stat.test <- stat.test %>% add_xy_position(x = "group")
bxp +
  stat_pvalue_manual(stat.test, tip.length = 0) +
  labs(subtitle = get_test_label(stat.test, detailed = TRUE))

```

```{r, echo=FALSE}
cat(sprintf("Количество вопросов модераторов коррелирует с количеством студентов записавшихся на курс.\nПоэтому нужно использовать нормализованные переменные - они позволяют избежать влияния спутывающей переменной количество студентов"))

```

### 3.2 Рассчеты

### 3.2.1 Влияние модераторской активности на вопросы пользователей

```{r, echo=FALSE}
cat(sprintf("У рассматриваемых переменных наблюдается гетероскедастичность, поэтому каждая из них подвергается трансформации с помощью функции log()\nЧтобы вывести из трансформации мы экспоненциируемы коэффициенты"))

```

```{r}
m1 <-  lm(log(1+q_learner_n) ~ log(1 + q_staff_n) + log(1 + ans_staff_n), courses)
summary(m1)
```
```{r , echo=FALSE}
a <- (exp(m1$coefficients[3]))
cat(sprintf("Рост количества нормализованных ответов модераторов на 1%% увеличит нормализованное количество вопросов пользователей на %.2f%%.\n", a))

```

```{r}
courses %>%
  ggplot(aes(y = log(1 + q_learner_n), x = log(1 + ans_staff_n))) + geom_point() +  geom_smooth(method="glm", color = "red")
courses %>%
  ggplot(aes(y = log(1+ q_learner_n), x = log(1+ q_staff_n))) + geom_point() +  geom_smooth(method="glm", color = "red")
```


### 3.2.2 Влияние модераторской активности на ответы пользователей

```{r}
m1 <-  lm(log(ans_learner_n +1) ~ log(1+q_staff_n) + log(1+ ans_staff_n), courses)
summary(m1)
```
```{r , echo=FALSE}
a <- (exp(m1$coefficients[2]))
cat(sprintf("Рост количества нормализованных вопросов модераторов на 1%% увеличит нормализованное количество ответов пользователей на %.2f%%.\n", a))

```

```{r, message=FALSE, warning=FALSE}
courses %>%
  ggplot(aes(y = log(1 + ans_learner_n), x = log(1+ ans_staff_n))) + geom_point() +  geom_smooth(method="glm", color = "red")

courses %>%
  ggplot(aes(y = log(1+ ans_learner_n), x = log(1+ q_staff_n))) + geom_point() +  geom_smooth(method="glm", color = "red")
```


### 3.2.3 Влияние модераторской активности на посещение форума пользователями

```{r}
m1 <-  lm(log(student_vis_mean) ~ log(1+q_staff_n) + log(1+ ans_staff_n), courses)
summary(m1)

```
```{r , echo=FALSE}
a <- (exp(m1$coefficients[2]))
cat(sprintf("Рост количества нормализованных ответов модераторов на 1%% увеличит среднее посещение форума студентами на %.2f%%.\n", a))

```

```{r, message=FALSE, warning=FALSE}
courses %>%
  ggplot(aes(y = log(1 + student_vis_mean), x = log(1+ q_staff_n))) + geom_point() +  geom_smooth(method="glm", color = "red")
```

```{r, message=FALSE, warning=FALSE}
courses %>%
  ggplot(aes(y = log(1 +student_vis_mean), x = log(1 + ans_staff_n))) + geom_point() +  geom_smooth(method="glm", color = "red")

```


## 4. Взаимодействие выживаемости и форумной активности

```{r}
 courses %>%
  ggplot(aes(x = passing_rate, y = log(1 +ans_staff_n))) + geom_point() +  geom_smooth(method = "lm")
courses %>%
  ggplot(aes(x = passing_rate, y = log(1 +q_staff_n))) + geom_point() +  geom_smooth(method = "lm")
```

```{r}

m1 <-  lm(log(passing_rate) ~ log(1+q_staff_n) + log(1+ ans_staff_n), courses)
summary(m1)
```

```{r, echo=FALSE}

cat(sprintf("Увеличение на 1 пункт в выживаемости курса уменьшает на %.3f пунктов значение нормализованных ответов модераторов.\nВеличина p = %.3f", exp(m1$coefficients[1]) - exp(m1$coefficients[1] + m1$coefficients[3]), summary(m1)$coefficients[12]))

```
```{r}
m1 <-  lm(log(passing_rate) ~ log(1+q_learner_n) + log(1+ ans_learner_n), courses)
summary(m1)

```

```{r, echo=FALSE}

cat(sprintf("Увеличение на 1 пункт в выживаемости курса уменьшает на %.3f пунктов значение нормализованных вопросов пользователей\nВеличина p = %.3f", exp(m1$coefficients[1]) - exp(m1$coefficients[1] + m1$coefficients[2]), summary(m1)$coefficients[10]))

```

## Выводы

Тактические выводы:

    1. Рост количества нормализованных ответов модераторов на 1% увеличивает на 0.85% посещение курса и на 1.34% нормализованное количество вопросов пользователей.
    2. Рост количества нормализованных вопросов модераторов на 1% увеличивает нормализованное количество ответов пользователей на 1.68%.
    3.  Увеличение на 1 пункт в выживаемости курса уменьшает на 11.351 пунктов значение нормализованных вопросов пользователей и на 7.413 пунктов значение нормализованных ответов модераторов.

Стратегические выводы:

    1. Посещение форума позволяет нам судить о сложности курса. Чем сложнее проходить курс, тем чаще студенты заходят на форум.
    2. Активность модераторов влияет на форумную активность студентов
      - если модераторы отвечают на вопросы, то это увеличивает посещение форума курса и подстегивает пользователей задавать больше вопросов
      - если модераторы задают вопросы, то это подстегивает пользователей отвечать на вопросы.
    3. Чем сложнее курс тем чаще студенты задают вопросы, а модераторы отвечают на них.
    
    