---
title: "Влияние модераторов и типов курса на посещение форума. Выживаемость"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(dplyr)
library(data.table)
library(lme4)
library(broom)
library(ggplot2)
library(tidyr)
library(arm)
library(rstatix)
library(ggpubr)

remove_outliers <- function(x, na.rm = TRUE, ...) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  y
}

```



```{r, include=FALSE}
wd <- getwd()
students <- fread("../data/students.csv") %>% group_by(course_id) %>%
  mutate(vis_p = remove_outliers(vis_p), duration = remove_outliers(duration)) %>%  mutate(grade_norm = remove_outliers(grade_norm)) %>% filter(duration < 750)
students$vis_b <-factor(students$vis_b)
students$spec_b <-factor(students$spec_b)


courses <- fread("../data/courses.csv")%>%
  mutate(vis_learner_p_norm = round(student_n / vis_learner_p, digits = 2), student_vis_mean = remove_outliers(student_vis_mean), passing_rate = passing_rate * 100,
         q_staff_n = round(q_staff / student_n, digits = 2) *100, ans_staff_n = round(ans_staff / student_n, digits = 2)*100, q_learner_n = round(q_learner / student_n, digits = 2) *100,
         ans_learner_n = round(ans_learner / student_n, digits = 2) *100,
         q_staff_b = case_when(
    q_staff_n >= 1 ~ 1,
    q_staff_n < 1  ~ 0
), ans_staff_b = case_when(
    ans_staff_n >= 1 ~ 1,
    ans_staff_n < 1  ~ 0
))


```

## 1. Об отчете

### Исследовательские вопросы

  1. Как длительность прохождения курса влияет на количество посещений форума?
  2. Как посещение форума варьируется в зависимости от курса?
  3. Как нормализованная длительность прохождения курса влияет на нормализованное посещение форума?

## Содержание отчета

  1. Связь между типом курса и средним посещением форума на курсе
  2. Связь между выживаемостью на курсе и средним посещением форума на курсе
  3. Связь между нормализованной активностью студентов и нормализованной активностью модераторов на форуме;
  4. Связь между выживаемостью на курсе и нормализованной активностью студентов и модераторов;

### Описание баз данных

- **students** - длинная база данных, с данными на уровне студентов
- **courses** - короткая база данных, с данными на уровне курсов

### Описание переменных

- **Тип задания** - бинарные переменные; сообщают есть ли такой тип задания на курсе;
  - ***is_prog*** - есть ли задание по программированию;
  - ***is_math*** - есть ли задание по математике;
  - ***is_peer*** - есть ли пир-ревью;
 
 
- **Метрики форума**
  - ***student_vis_mean*** - среднее посещение форума студентами на курсе;
  - ***ans_learner*** - абсолютное количество ответов студентов на курсе;
  - ***q_learner*** - абсолютное количество вопросов студентов на курсе;
  - ***ans_learner_n*** - количество ответов студентов на курсе / количество студентов на курсе;
  - ***q_learner_n*** - количество вопросов студентов на курсе / количество студентов на курсе;

- **Метрики активности модераторов**
  - ***ans_staff*** - абсолютное количество ответов модераторов на курсе;
  - ***q_staff*** - абсолютное количество вопросов модераторов на курсе;
  - ***ans_staff_b*** - отвечали ли модераторы на вопросы на курсе (1 от 10 ответов);
  - ***q_staff_b*** - задавали ли модераторы вопросы на курсе (1 от 10 вопросов);
  - ***ans_staff_n*** - (количество ответов модераторов / количество студентов) *100;
  - ***q_staff_n*** - (количество вопросов модераторов / количество студентов) * 100;
 
 
- **Метрика выживаемости**
  - ***passing_rate*** - прошедшие курс / записавшиеся на курс

### Как создавались бинарные переменные типов заданий
 - К сожалению, не всегда удается автоматически определить какие на курсе задания, а потому приходится использовать разнообразные признаки для их кодирования.
  - ***is_prog***
    - есть ли в таблице course_items.csv задания со словом "programming";
    - есть ли в таблице assessment_questions.csv вопросы с типом 14 (codeExpression)
  - ***is_math***
    - есть ли задания в таблице assessment_math_expression_questions.csv;
    - есть ли в таблице peer_assignment_submission_schema_parts.csv слова "math","calculate", "Рассчитайте"
  - ***is_peer***
    - есть ли в таблице 'course_items.csv' задание с типом 104 (peer-review);

```{r , echo=FALSE}

cat(sprintf("Распределение курсов по типу заданий:\n"))
a <- courses %>% summarise(yes = sum(is_prog_b), no = n() - yes)
b <- courses %>% summarise(yes = sum(is_math_b), no = n() - yes)
c <- courses %>% summarise(yes = sum(is_peer_b), no = n() - yes)
d <- rbind(a, b, c)
d$course_with <- c("prog", "math", "peer")
d %>% dplyr::select(course_with, yes, no)
courses <-  courses %>% mutate(is_prog_b = factor(is_prog_b),
  is_math_b = factor(is_math_b),is_peer_b = factor(is_peer_b), ans_staff_b = factor(ans_staff_b), q_staff_b = factor(q_staff_b))
```


## 1. Тип курса и среднее посещение
### 1.1 Описательная статистика

- Чтобы выяснить взаимоотношением между средним посещением и типом курса мы будем использовать **Mann-Whitney U test** потому что:
  - Переменная ***student_vis_mean***:
    - непрерывная;
    - скошена влево, а значит нарушена предпосылка нормальности;
    - тест Шапиро также показывает, что распределение этой переменной значимо отличается от нормального;
  - Переменные  ***is_prog***, ***is_math***, ***is_peer***
    - бинарные;
    - значения этих переменных независимы;
    - их распределения должны походить друг на друга.
- Mann-Whitney U test - это аналог t-test для ненормально распределенной зависимой переменной.


```{r, warning=FALSE, message=FALSE}
gghistogram(courses, x = "student_vis_mean", y = "..density..",
            fill = "steelblue",bins = 30, add_density = TRUE)
shapiro.test(courses$student_vis_mean)

courses %>%
  ggplot(aes(x = student_vis_mean)) + geom_histogram() + facet_wrap(~is_peer_b, labeller = labeller(yes = "1", no = "0")) + labs(x = "Посещение форума в среднем по курсу", y = "Количество курсов с таким посещением")

```


### 1.2 Mann-Whitney U tests в виде расчетов и с силой эффекта
#### Во всех трех случаях есть значимая разница в среднем посещении форума между курсами с разными типами заданий

```{r, include=FALSE}

wt1 <- wilcox.test(student_vis_mean ~ is_prog_b, courses)
w1 <- courses %>% wilcox_effsize(student_vis_mean ~ is_prog_b)
wt2 <- wilcox.test(student_vis_mean ~ is_math_b, courses)
w2 <- courses %>% wilcox_effsize(student_vis_mean ~ is_math_b)
wt3 <- wilcox.test(student_vis_mean ~ is_peer_b, courses)
w3 <- courses %>% wilcox_effsize(student_vis_mean ~ is_peer_b)
```

```{r, echo=FALSE}
wt1
w1$effsize
wt2
w2$effsize
wt3
w3$effsize
```

### 1.3 Mann-Whitney U tests в виде графиков
#### На графиках указаны статистики теста и значимость различий между курсами с разными типами заданий

```{r}

stat.test <- courses %>%
  wilcox_test(student_vis_mean ~ is_prog_b) %>%
  add_significance()
bxp <- ggboxplot(
  courses, x = "is_prog_b", y = "student_vis_mean",
  ylab = "Посещение форума в среднем по курсу", xlab = "Курс с программированием", add = "jitter") +
scale_x_discrete(labels=c("Нет","Да"))
stat.test <- stat.test %>% add_xy_position(x = "group")
bxp +
  stat_pvalue_manual(stat.test, tip.length = 0) +
  labs(subtitle = get_test_label(stat.test, detailed = TRUE))
 

stat.test <- courses %>%
  wilcox_test(student_vis_mean ~ is_math_b) %>%
  add_significance()
bxp <- ggboxplot(
  courses, x = "is_math_b", y = "student_vis_mean",
  ylab = "Посещение форума в среднем по курсу", xlab = "Курс с математическими рассчетами", add = "jitter") +
scale_x_discrete(labels=c("Нет","Да"))
stat.test <- stat.test %>% add_xy_position(x = "group")
bxp +
  stat_pvalue_manual(stat.test, tip.length = 0) +
  labs(subtitle = get_test_label(stat.test, detailed = TRUE))
 

stat.test <- courses %>%
  wilcox_test(student_vis_mean ~ is_peer_b) %>%
  add_significance()
bxp <- ggboxplot(
  courses, x = "is_peer_b", y = "student_vis_mean",
  ylab = "Посещение форума в среднем по курсу", xlab = "Курс с взаимный оцениванием", add = "jitter") +
scale_x_discrete(labels=c("Нет","Да"))
stat.test <- stat.test %>% add_xy_position(x = "group")
bxp +
  stat_pvalue_manual(stat.test, tip.length = 0) +
  labs(subtitle = get_test_label(stat.test, detailed = TRUE))
 
```

## 2. Посещение форума и выживаемость на курсе

### 2.1 Анализ распределения остатков

```{r, message=FALSE, warning=FALSE}
courses %>%
  ggplot(aes(x = passing_rate, y = student_vis_mean)) + geom_point() +  geom_smooth(method = "lm")

```

```{r}
m1 <-  lm((student_vis_mean) ~ passing_rate, courses)
res <- resid(m1)
plot(fitted(m1), res)
abline(0,0)
qqnorm(res)
qqline(res)
```

```{r, echo=FALSE}

cat(sprintf("Мы видим, что распределение остатков нельзя назвать нормальным поскольку большая часть значений student_vis_mean распределены близко к нулю.\nПоэтому мы трансформировали эту переменную с помощью функции log() \n"))

```

```{r}
m1 <-  lm(log(student_vis_mean) ~ passing_rate, courses)
summary(m1)
```
```{r, echo=FALSE}

cat(sprintf("Теперь остатки распределены более равномерно \n"))

```

```{r, message=FALSE, warning=FALSE}
courses %>%
  ggplot(aes(x = passing_rate, y = log(student_vis_mean))) + geom_point() +  geom_smooth(method = "lm")


```
```{r}
m1 <-  lm(log(student_vis_mean) ~ passing_rate, courses)
res <- resid(m1)
plot(fitted(m1), res)
abline(0,0)
qqnorm(res)
qqline(res)
```



```{r, echo=FALSE}

cat(sprintf("Изменение на 1 пункт в выживаемости курса уменьшает на %.3f пунктов среднее количество посещений форума.\nЧтобы получить данное значение мы нашли разницу между интерсептом и интерсепт + угол наклона, а полученное значение экспоненциировали\nЭто изменение значимо с p = %.f", exp(m1$coefficients[1]) - exp(m1$coefficients[1] + m1$coefficients[2]), summary(m1)$coefficients[7]))

```

## 3. Модераторы и их влияние
### 3.1 Описание переменных и обоснование их выбора



```{r, echo=FALSE}
cat(sprintf("Распределение переменной q_staff_n:\n"))
table(courses$q_staff_n)
cat(sprintf("\nРаспределение переменной ans_staff_n:\n"))
table(courses$ans_staff_n)
```

```{r, echo=FALSE}
stat.test <- courses %>%
  wilcox_test(student_n ~ q_staff_b) %>%
  add_significance()
bxp <- ggboxplot(
  courses, x = "q_staff_b", y = "student_n",
  ylab = "Количество студентов на курсе", xlab = "Спрашивают ли модераторы?", add = "jitter") +
scale_x_discrete(labels=c("Нет","Да"))
stat.test <- stat.test %>% add_xy_position(x = "group")
bxp +
  stat_pvalue_manual(stat.test, tip.length = 0) +
  labs(subtitle = get_test_label(stat.test, detailed = TRUE))

stat.test <- courses %>%
  wilcox_test(student_n ~ ans_staff_b) %>%
  add_significance()
bxp <- ggboxplot(
  courses, x = "ans_staff_b", y = "student_n",
  ylab = "Количество студентов на курсе", xlab = "Отвечают ли модераторы?", add = "jitter") +
scale_x_discrete(labels=c("Нет","Да"))
stat.test <- stat.test %>% add_xy_position(x = "group")
bxp +
  stat_pvalue_manual(stat.test, tip.length = 0) +
  labs(subtitle = get_test_label(stat.test, detailed = TRUE))

```

```{r, echo=FALSE}
cat(sprintf("Количество вопросов модераторов коррелирует с количеством студентов записавшихся на курс.\nПоэтому нужно использовать нормализованные переменные - они позволяют избежать влияния спутывающей переменной количество студентов"))

```

### 3.2 Рассчеты

### 3.2.1 Влияние модераторской активности на вопросы пользователей

```{r, echo=FALSE}
cat(sprintf("У рассматриваемых переменных наблюдается гетероскедастичность, поэтому каждая из них подвергается трансформации с помощью функции log()\nЧтобы вывести из трансформации мы экспоненциируемы коэффициенты"))

```

```{r}
m1 <-  lm(log(1+q_learner_n) ~ log(1 + q_staff_n) + log(1 + ans_staff_n), courses)
summary(m1)
```
```{r , echo=FALSE}
a <- (exp(m1$coefficients[3]))
cat(sprintf("Рост количества нормализованных ответов модераторов на 1%% увеличит нормализованное количество вопросов пользователей на %.2f%%.\n", a))

```

```{r}
courses %>%
  ggplot(aes(y = log(1 + q_learner_n), x = log(1 + ans_staff_n))) + geom_point() +  geom_smooth(method="glm", color = "red")
courses %>%
  ggplot(aes(y = log(1+ q_learner_n), x = log(1+ q_staff_n))) + geom_point() +  geom_smooth(method="glm", color = "red")
```


### 3.2.2 Влияние модераторской активности на ответы пользователей

```{r}
m1 <-  lm(log(ans_learner_n +1) ~ log(1+q_staff_n) + log(1+ ans_staff_n), courses)
summary(m1)
```
```{r , echo=FALSE}
a <- (exp(m1$coefficients[2]))
cat(sprintf("Рост количества нормализованных вопросов модераторов на 1%% увеличит нормализованное количество ответов пользователей на %.2f%%.\n", a))

```

```{r, message=FALSE, warning=FALSE}
courses %>%
  ggplot(aes(y = log(1 + ans_learner_n), x = log(1+ ans_staff_n))) + geom_point() +  geom_smooth(method="glm", color = "red")

courses %>%
  ggplot(aes(y = log(1+ ans_learner_n), x = log(1+ q_staff_n))) + geom_point() +  geom_smooth(method="glm", color = "red")
```


### 3.2.3 Влияние модераторской активности на посещение форума пользователями

```{r}
m1 <-  lm(log(student_vis_mean) ~ log(1+q_staff_n) + log(1+ ans_staff_n), courses)
summary(m1)

```
```{r , echo=FALSE}
a <- (exp(m1$coefficients[2]))
cat(sprintf("Рост количества нормализованных ответов модераторов на 1%% увеличит среднее посещение форума студентами на %.2f%%.\n", a))

```

```{r, message=FALSE, warning=FALSE}
courses %>%
  ggplot(aes(y = log(1 + student_vis_mean), x = log(1+ q_staff_n))) + geom_point() +  geom_smooth(method="glm", color = "red")
```

```{r, message=FALSE, warning=FALSE}
courses %>%
  ggplot(aes(y = log(1 +student_vis_mean), x = log(1 + ans_staff_n))) + geom_point() +  geom_smooth(method="glm", color = "red")

```


## 4. Взаимодействие выживаемости и форумной активности

```{r}
 courses %>%
  ggplot(aes(x = passing_rate, y = log(1 +ans_staff_n))) + geom_point() +  geom_smooth(method = "lm")
courses %>%
  ggplot(aes(x = passing_rate, y = log(1 +q_staff_n))) + geom_point() +  geom_smooth(method = "lm")
```

```{r}

m1 <-  lm(log(passing_rate) ~ log(1+q_staff_n) + log(1+ ans_staff_n), courses)
summary(m1)
```

```{r, echo=FALSE}

cat(sprintf("Увеличение на 1 пункт в выживаемости курса уменьшает на %.3f пунктов значение нормализованных ответов модераторов.\nВеличина p = %.3f", exp(m1$coefficients[1]) - exp(m1$coefficients[1] + m1$coefficients[3]), summary(m1)$coefficients[12]))

```
```{r}
m1 <-  lm(log(passing_rate) ~ log(1+q_learner_n) + log(1+ ans_learner_n), courses)
summary(m1)

```

```{r, echo=FALSE}

cat(sprintf("Увеличение на 1 пункт в выживаемости курса уменьшает на %.3f пунктов значение нормализованных вопросов пользователей\nВеличина p = %.3f", exp(m1$coefficients[1]) - exp(m1$coefficients[1] + m1$coefficients[2]), summary(m1)$coefficients[10]))

```
## Выводы

Тактические выводы:

    1. Согласно критерию Манна-Уитни на курсах, где есть задания с программированием значимо больше средних посещений чем на курсах  без них. Такая же ситуация с на курсах с заданиями с математикой и взаимной оценкой. Размеры эффектов: от 0.3 до 0.38.
    2. Чем сложнее курс, тем чаще студенты заходят на форум. Увеличение на 1 пункт в выживаемости курса уменьшает на 1.12 пунктов среднее количество посещений форума.
    3. Рост количества нормализованных ответов модераторов на 1% увеличивает на 0.85% посещение курса и на 1.34% нормализованное количество вопросов пользователей.
    4. Рост количества нормализованных вопросов модераторов на 1% увеличивает нормализованное количество ответов пользователей на 1.68%.
    5.  Увеличение на 1 пункт в выживаемости курса уменьшает на 11.351 пунктов значение нормализованных вопросов пользователей и на 7.413 пунктов значение нормализованных ответов модераторов.

Стратегические выводы:

    1. Посещение форума позволяет нам судить о сложности курса. Чем сложнее проходить курс, тем чаще студенты заходят на форум.
    2. Задания по программированию, по математике, пир-ревью задания - сложные и вынуждают пользователей заходить на форум
    3. Активность модераторов влияет на форумную активность студентов
      - если модераторы отвечают на вопросы, то это увеличивает посещение форума курса и подстегивает пользователей задавать больше вопросов
      - если модераторы задают вопросы, то это подстегивает пользователей отвечать на вопросы.
    4. Чем сложнее курс тем чаще студенты задают вопросы, а модераторы отвечают на них.
    
    